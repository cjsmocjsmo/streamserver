
services:
  motion-detection-pi3b:
    build: 
      context: .
      dockerfile: Dockerfile
    image: motion-stream-pi3b:latest
    container_name: motion-detection-pi3b
    
    # Network configuration
    ports:
      - "8000:8000"
    
    # Hardware access (generic Linux)
    devices:
      - "/dev/video0:/dev/video0"        # USB/CSI camera
    
    # Volume mounts
    volumes:
      - "./recordings:/app/recordings"           # Persistent video storage
      - "./motion_config.ini:/app/motion_config.ini:ro"  # Configuration (read-only)
      - "./logs:/app/logs"                       # Application logs
    
    # Environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/usr/lib/python3/dist-packages:/usr/local/lib/python3.12/site-packages
    
    # Security and permissions (minimal)
    group_add:
      - video                          # Video device access only
    
    # Restart policy
    restart: unless-stopped
    
    # Health monitoring
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 30s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Optional: Network for multiple services
networks:
  default:
    name: motion-detection-network